<!-- e1b72265-830e-4be3-b0ca-870fd7bf4a90 8e56eb41-cf2b-44a7-ac5e-fcac05b99198 -->
# 学生QRスキャン機能の実装

## 現状分析

### 完成している部分

- **教員スキャン機能**: `StudentAttendanceService.recordQRAttendance()` (36-120行目)
  - 学生ID、現在時刻から該当授業を自動検索
  - 履修確認後、出席記録を作成
  - `backend-nodejs/services/StudentAttendanceService.js`

### 未完成の部分

- **QRService.scanQRCode()**: ダミー実装 (14-16行目)
  - `backend-nodejs/services/QRService.js`
- **学生側フロントエンド**: グループQRコード用の実装になっている
  - `src/components/common/StudentQRScanner.jsx`
  - `src/pages/StudentDashboardPage.jsx` (82-111行目)

## 実装方針

**学校固有QRコード**: `"SCHOOL_ATTENDANCE_2025"` のような固定文字列

**時間制限**: ホームルーム開始時刻まで（バックエンドで検証）

**複数授業対応**: 学生に選択させる（フロントエンドで選択UI表示）

## 実装内容

### 1. バックエンド: QRService.scanQRCode() の実装

**ファイル**: `backend-nodejs/services/QRService.js`

```javascript
static async scanQRCode(data) {
  const { qr_data, timestamp, scanned_by } = data;
  
  // 1. QRコードが学校固有のものか検証
  if (!qr_data.startsWith('SCHOOL_ATTENDANCE')) {
    return { success: false, message: '無効なQRコードです' };
  }
  
  // 2. スキャンしたユーザー（学生）の情報を取得
  const user = await query('SELECT * FROM users WHERE id = ?', [scanned_by]);
  if (!user[0] || user[0].role !== 'student') {
    return { success: false, message: '学生としてログインしてください' };
  }
  
  const studentId = user[0].student_id;
  
  // 3. 現在時刻と曜日から該当する授業を検索
  const currentTime = new Date().toTimeString().split(' ')[0];
  const dayOfWeek = this.getDayOfWeek(new Date());
  
  const classes = await query(
    `SELECT c.*, s.subject_name, e.id as enrollment_id
     FROM classes c
     JOIN subjects s ON c.subject_id = s.id
     JOIN enrollments e ON c.id = e.class_id
     WHERE e.student_id = ? 
     AND c.schedule_day = ? 
     AND c.start_time <= ? 
     AND c.is_active = TRUE
     AND e.status = 'enrolled'`,
    [studentId, dayOfWeek, currentTime]
  );
  
  // 4. 該当授業が複数ある場合は選択肢を返す
  if (classes.length > 1) {
    return {
      success: true,
      requiresSelection: true,
      message: '複数の授業が見つかりました。選択してください。',
      data: { classes }
    };
  }
  
  // 5. 該当授業が1つの場合は自動記録
  if (classes.length === 1) {
    return await StudentAttendanceService.recordQRAttendance(studentId, timestamp);
  }
  
  // 6. 該当授業がない場合
  return {
    success: false,
    message: '現在時刻に該当する授業が見つかりません'
  };
}
```

### 2. バックエンド: 授業選択後の記録エンドポイント追加

**ファイル**: `backend-nodejs/routes/qr.js`

105行目の `/scan` エンドポイントの後に追加:

```javascript
router.post('/scan/confirm', authenticate, [
  body('class_id').isInt().withMessage('授業IDが必要です'),
  body('timestamp').optional().isISO8601()
], async (req, res) => {
  try {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        message: '入力データにエラーがあります',
        errors: errors.array()
      });
    }
    
    const { class_id, timestamp } = req.body;
    const user = await query('SELECT student_id FROM users WHERE id = ?', [req.user.id]);
    
    if (!user[0]) {
      return res.status(404).json({
        success: false,
        message: 'ユーザーが見つかりません'
      });
    }
    
    const result = await StudentAttendanceService.recordQRAttendance(
      user[0].student_id,
      timestamp,
      class_id
    );
    
    res.status(result.success ? 201 : 400).json(result);
  } catch (error) {
    logger.error('授業選択記録APIエラー:', error.message);
    res.status(500).json({
      success: false,
      message: 'サーバーエラーが発生しました'
    });
  }
});
```

### 3. バックエンド: StudentAttendanceService.recordQRAttendance() の修正

**ファイル**: `backend-nodejs/services/StudentAttendanceService.js`

36行目のメソッドに `classId` パラメータを追加し、授業検索をスキップ:

```javascript
static async recordQRAttendance(studentId, timestamp, classId = null) {
  // classIdが指定されている場合は検索をスキップ
  let classes = [];
  if (classId) {
    classes = await query(
      `SELECT c.*, s.subject_name 
       FROM classes c
       JOIN subjects s ON c.subject_id = s.id
       WHERE c.id = ?`,
      [classId]
    );
  } else {
    // 既存の検索ロジック（60-73行目）
  }
  // 以降は既存のロジック
}
```

### 4. フロントエンド: StudentQRScanner.jsx の修正

**ファイル**: `src/components/common/StudentQRScanner.jsx`

- QRコード解析部分を修正（14-34行目）
- 授業選択UIを追加
```jsx
const handleScan = (detectedCodes) => {
  if (detectedCodes && detectedCodes.length > 0) {
    setIsScanning(false);
    try {
      const qrData = detectedCodes[0].rawValue.trim();
      // 学校固有のQRコードをそのまま渡す
      onScan({ qrData });
    } catch (err) {
      setError('QRコードの解析に失敗しました');
    }
  }
};
```


授業選択UI（新規追加）:

```jsx
{scanResult?.requiresSelection && (
  <div className="class-selection">
    <h3>授業を選択してください</h3>
    {scanResult.classes.map(cls => (
      <button
        key={cls.id}
        onClick={() => onSelectClass(cls.id)}
        className="class-option"
      >
        {cls.subject_name} - {cls.class_code}
        <br />
        <small>{cls.start_time} - {cls.end_time}</small>
      </button>
    ))}
  </div>
)}
```

### 5. フロントエンド: StudentDashboardPage.jsx の修正

**ファイル**: `src/pages/StudentDashboardPage.jsx`

82-111行目の `handleQRScan` を修正:

```jsx
const handleQRScan = async (scanData) => {
  requireAuth(async () => {
    try {
      setIsLoading(true);
      setError(null);
      
      const response = await attendanceApi.recordScan(
        scanData.qrData,
        new Date().toISOString()
      );
      
      if (response.success && response.requiresSelection) {
        // 複数授業がある場合は選択UIを表示
        setClassSelectionData(response.data.classes);
      } else if (response.success) {
        // 記録成功
        setShowQRScanner(false);
        alert(`出席記録が完了しました！`);
        await loadStudentData();
      } else {
        setError(response.message);
      }
    } catch (err) {
      setError('出欠記録の送信に失敗しました');
    } finally {
      setIsLoading(false);
    }
  });
};

const handleSelectClass = async (classId) => {
  try {
    setIsLoading(true);
    const response = await attendanceApi.confirmClassAttendance(
      classId,
      new Date().toISOString()
    );
    
    if (response.success) {
      setShowQRScanner(false);
      setClassSelectionData(null);
      alert(`出席記録が完了しました！`);
      await loadStudentData();
    } else {
      setError(response.message);
    }
  } catch (err) {
    setError('出欠記録の送信に失敗しました');
  } finally {
    setIsLoading(false);
  }
};
```

### 6. フロントエンド: attendanceApi.js にメソッド追加

**ファイル**: `src/api/attendanceApi.js`

542行目の後に追加:

```javascript
// 授業選択後の出席記録
confirmClassAttendance: async (classId, timestamp = null) => {
  const response = await apiClient.post('/qr/scan/confirm', {
    class_id: classId,
    timestamp
  });
  return response.data;
},
```

## テスト項目

1. 学校QRコードスキャン → 授業1つ → 自動記録
2. 学校QRコードスキャン → 授業複数 → 選択UI表示 → 記録
3. 学校QRコードスキャン → 授業なし → エラーメッセージ
4. 無効なQRコード → エラーメッセージ
5. 教員アカウントでスキャン → エラーメッセージ

### To-dos

- [ ] QRService.scanQRCode()を実装（学校QRコード検証、授業検索、複数授業対応）
- [ ] routes/qr.jsに/scan/confirmエンドポイントを追加
- [ ] StudentAttendanceService.recordQRAttendance()にclassIdパラメータを追加
- [ ] StudentQRScanner.jsxを修正（QRコード解析、授業選択UI追加）
- [ ] StudentDashboardPage.jsxのhandleQRScanとhandleSelectClassを実装
- [ ] attendanceApi.jsにconfirmClassAttendance()メソッドを追加
- [ ] 全テストケースを実行して動作確認